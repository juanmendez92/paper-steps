<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-styles/color.html">
<link rel="import" href="../paper-styles/typography.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-icons/image-icons.html">
<link rel="import" href="../paper-button/paper-button.html">

<!--
An element which provides a solution to material design steppers.

Example:

    <paper-step label="Do something"></paper-step>

Example:

    <paper-step optional></paper-step>

@demo demo/index.html
-->

<dom-module id="paper-step">
  <style>
    :root {
      --paper-step-primary-color: var(--primary-backround-color, --paper-indigo-500);
      --paper-step-disabled-color: var(--disabled-text-color, --google-grey-500);
    }

    :host {
      var(--paper-font-common-base);
    }

    :host .h-label {
      margin: 0 8px;
      white-space: nowrap;
    }

    :host .label {
      margin-left: 12px;
    }

    :host .line {
      margin-right: 8px;
      width: 100%;
      height: 1px;
      background-color: var(--paper-grey-300);
    }

    :host .stepper-circle {
      width: 24px;
      height: 24px;
      line-height: 24px;
      border-radius: 50%;
      color: #fff;
      font-size: 12px;
      text-align: center;
    }

    :host(.iron-selected) .stepper-circle {
      background-color: var(--primary-color, --paper-step-primary-color);
    }

    :host(:not(.iron-selected)) .stepper-circle {
      background-color: var(--disabled-text-color, --paper-step-disabled-color);
    }

    :host .label .optional-text,
    :host .h-label .optional-text {
      color: var(--disabled-text-color, --paper-step-disabled-color);
      position: absolute;
      font-weight: normal;
      margin-top: 17px;
      font-size: 12px;
    }

    :host .h-label .optional-text {
      margin-top: 17px;
    }

    :host(.iron-selected) .label,
    :host(.iron-selected) .h-label {
      font-weight: 500;
    }

    :host #actions {
      margin-top: 15px;
      position: relative;
      left: -5px;
    }

    :host #actions paper-button {
      margin-right: 10px;
    }

    :host #actions #continue,
    :host #actions #skip {
      background-color: var(--paper-step-primary-color);
      color: #fff;
    }

    button {
      -webkit-appearance: none;
      border: 0;
      padding: 0;
      background: transparent;
    }

    button paper-button {
      @apply(--paper-font-common-base);
      font-size: 14px;
    }

  </style>
  <template>
    <div class$="stepper-circle {{_cssClass}}">
      <span>{{step}}</span>
    </div>

    <span class$="h-label {{_cssClass}}">
      <span class="optional-text" hidden$="[[!optional]]">Optional</span>
      [[label]]
    </span>

    <div class="line"></div>

    <span hidden$="[[!label]]" class$="label {{_cssClass}}">
      <span class="optional-text" hidden$="[[!optional]]">Optional</span>
      [[label]]
    </span>

    <div id="content" class$="{{_cssClass}}" >
      <div hidden$="{{!_selected}}">
        <content></content>

        <div id="actions" hidden$={{actionsDisabled}}>
          <paper-button id="continue" class="actions" on-click="_submit" raised>{{continueLabel}}</paper-button>
          <paper-button id="cancel" class="actions" on-click="_reset" raised>{{cancelLabel}}</paper-button>
          <paper-button id="skip" class="actions" on-click="_skip"
          raised hidden$="{{!optional}}">Skip</paper-button>
        </div>
      </div>
    </div>
  </template>
  <script>
    'use strict';
    Polymer({
      is: "paper-step",
      properties: {
        /**
         * Computed css classes based on the current `step` and the total
         * number value of `steps`.
         */
        _cssClass: {
          type: String,
          computed: '__cssClass(step, steps)'
        },
        /**
         * Computed for the `paper-step` image icon based on the supplied `icon` attribute.
         */
        _image: {
          type: String,
          computed: '_icon(icon, step)'
        },
        /**
         * Indicates if the current `paper-step` is selected and toggles the
         * active/inactive css style rules.
         */
        _selected: {
          type: Boolean,
          value: false
        },
        /**
         * If true, the submit buttons which are automatically
         * added will be hidden for this `paper-step` element.
         */
        actionsDisabled: {
          type: Boolean
        },
        /**
         * If true, the current step has been validated and marked as done.
         */
        completed: {
          type: Boolean,
          value: false,
          readonly: true
        },
        /**
         *  Specify an alternate label to use for the `continue` button.
         */
        continueLabel: {
          type: String,
          value: 'Continue'
        },
        /**
         *  Specify an alternate label to use for the `cancel` button.
         */
        cancelLabel: {
          type: String,
          value: 'Cancel'
        },
        /**
         * The text to display in the steps area next to the image icon.
         */
        label: {
          type: String
        },
        /**
         * To indicate if the current step required or optional.
         */
        optional: {
          type: Boolean,
          value: false
        },
        /**
         * The 1 based index value for the current `paper-step` in `paper-steps`.
         *
         * `Automatically calculated`.
         */
        step: {
          type: Number
        },
        /**
         * The value for the total number of `paper-step` elements (readonly).
         *
         * `Automatically calculated`.
         */
        steps: {
          type: Number,
          readonly: true
        }
      },
      behaviors: [],
      listeners: {
        // //error after submit, IronRequestElement in event.detail object
        // 'iron-form-error': '',
        // //cannot submit, form is invalid
        // 'iron-form-invalid': '',
        // 'iron-form-presubmit': '',
        // //after form is reset
        // 'iron-form-reset': '_reset',
        // //after form submitted, IronRequestElement inevent.detail object
        // 'iron-form-response': '',
        // 'iron-form-submit': '_submit' //after submitted
      },

      // Element Lifecycle
      ready: function() {},

      attached: function() {
        var
          parent = this.parentNode && this.parentNode.indexOf && this.parentNode || null
        ;

        // @TODO: finish adding fallback for shadowDom, not yet ready.
        if (!Boolean(parent) && this.shadowRoot) {
          try {
            parent = this.parentNode.$.selector;
          } catch (e) {
            parent = null;
          }
        }

        //
        if (!parent || parent.hasOwnProperty('indexOf') || typeof parent.indexOf != 'function') {
          this.step = 1;
          this.steps = 1;
          try {
            console.log('Improperly declared paper-step element, ' +
              'it is missing the parent iterator.');
            // console.log(this, typeof parent.indexOf, typeof parent.items);
          } catch (e) {}
          return;
        }

        if (!Boolean(this.step)) {
          this.step = parent.indexOf(this) + 1;
        }

        if (!Boolean(this.steps)) {
          this.steps = parent.items.length;
        }

      },

      detached: function() {},

      /**
       * Computes `_cssClass` property.
       * @return {string}.
       */
      __cssClass: function(step, steps) {
        var cls = (this.optional ? 'optional' : 'required') + '-step ';

        if (step === 1) {
          cls += 'first ';
        }
        if (step === steps) {
          cls += 'last ';
        }
        return cls;
      },
      _getForm: function() {
        var
          el = Polymer.dom(this.$.content),
          form = el && el.node &&
            el.node.querySelector('div form[is="iron-form"]')
        ;
        return form || false;
      },
      /**
       * Computes `image` property based on step `icon` and current `step`.
       * @return {string}.
       */
      _icon: function(icon, step) {
        return 'image:brightness-1';
      },
      /**
       * Clear the state form elements.
       */
      _reset: function(e) {
        var
          form = this._getForm()
        ;

        // reset form if it exists.
        if (form) {
          form.reset();
        }
      },
      /**
       * Check if form is valid and then trigger the form `submit` event.
       */
      _submit: function(e) {
        var
          form = this._getForm()
        ;

        // submit form if it exists.
        if (form && form.validate()) {
          form.submit();
        }
      }
    });
  </script>
</dom-module>
